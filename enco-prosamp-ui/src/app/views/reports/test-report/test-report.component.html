<!-- Search & Add -->
<c-row class="mb-3">
  <c-col md="6">
    <input class="form-control" placeholder="Keresés jelentés száma vagy címe alapján..."
           [(ngModel)]="filterText" />
  </c-col>
  <c-col md="6" class="text-end">
    <button cButton color="primary" (click)="openModal()">Új Jelentés</button>
  </c-col>
</c-row>

<!-- Table -->
<c-card>
  <c-card-header><strong>Vizsgálati Jelentések</strong></c-card-header>
  <c-card-body>
    <div class="table-responsive">
      <table class="table table-hover table-bordered">
        <thead>
        <tr>
          <th (click)="toggleSort('reportNumber')" class="sortable">
            <span class="sort-header">
              Jelentés Szám
              <i class="fa"
                 [ngClass]="{
                   'fa-sort-up': sortColumn === 'reportNumber' && sortDirection === 'asc',
                   'fa-sort-down': sortColumn === 'reportNumber' && sortDirection === 'desc',
                   'fa-sort': sortColumn !== 'reportNumber'
                 }"></i>
            </span>
          </th>

          <th (click)="toggleSort('title')" class="sortable">
            <span class="sort-header">
              Cím
              <i class="fa"
                 [ngClass]="{
                   'fa-sort-up': sortColumn === 'title' && sortDirection === 'asc',
                   'fa-sort-down': sortColumn === 'title' && sortDirection === 'desc',
                   'fa-sort': sortColumn !== 'title'
                 }"></i>
            </span>
          </th>

          <th (click)="toggleSort('issueDate')" class="sortable">
            <span class="sort-header">
              Kiadás Dátuma
              <i class="fa"
                 [ngClass]="{
                   'fa-sort-up': sortColumn === 'issueDate' && sortDirection === 'asc',
                   'fa-sort-down': sortColumn === 'issueDate' && sortDirection === 'desc',
                   'fa-sort': sortColumn !== 'issueDate'
                 }"></i>
            </span>
          </th>

          <th (click)="toggleSort('reportStatus')" class="sortable">
            <span class="sort-header">
              Státusz
              <i class="fa"
                 [ngClass]="{
                   'fa-sort-up': sortColumn === 'reportStatus' && sortDirection === 'asc',
                   'fa-sort-down': sortColumn === 'reportStatus' && sortDirection === 'desc',
                   'fa-sort': sortColumn !== 'reportStatus'
                 }"></i>
            </span>
          </th>

          <th>Műveletek</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let report of filteredReports">
          <td>{{ report.reportNumber }}</td>
          <td>{{ report.title }}</td>
          <td>{{ report.issueDate }}</td>
          <td>{{ report.reportStatus }}</td>
          <td>
            <button cButton color="warning" (click)="openModal(report)">Szerkesztés</button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </c-card-body>
</c-card>

<!-- Modal -->
<c-modal [visible]="isModalOpen" (close)="closeModal()" backdrop="static" keyboard="false">
  <c-modal-header>
    <h5 class="modal-title">{{ selectedReportId ? 'Edit Test Report' : 'New Test Report' }}</h5>
  </c-modal-header>
  <c-modal-body>
    <form #reportForm="ngForm" (ngSubmit)="onSubmit(reportForm)" [validated]="formValidated" cForm class="row g-3">

      <!-- Report Number -->
      <c-col md="6">
        <label cLabel for="reportNumber">Report Number</label>
        <input class="form-control" id="reportNumber" name="reportNumber" required [(ngModel)]="newReport.reportNumber" />
        <c-form-feedback [valid]="false">This field is required.</c-form-feedback>
      </c-col>

      <!-- Title -->
      <c-col md="6">
        <label cLabel for="title">Title</label>
        <input class="form-control" id="title" name="title" required [(ngModel)]="newReport.title" />
        <c-form-feedback [valid]="false">This field is required.</c-form-feedback>
      </c-col>

      <!-- Aim of Test -->
      <c-col md="12">
        <label cLabel for="aimOfTest">Aim of Test</label>
        <textarea class="form-control" id="aimOfTest" name="aimOfTest" [(ngModel)]="newReport.aimOfTest"></textarea>
      </c-col>

      <!-- Project Selection -->
      <c-col md="6" class="mt-3">
        <label cLabel for="project">Project</label>
        <button cButton color="primary" (click)="openProjectLookup()">Select Project</button>
      </c-col>

      <!-- Location Selection -->
      <c-col md="6" class="mt-3">
        <label cLabel for="location">Location</label>
        <button cButton color="primary" (click)="openLocationLookup()">Select Location</button>
      </c-col>

      <!-- Date and Status -->
      <c-col md="6">
        <label cLabel for="issueDate">Issue Date</label>
        <input class="form-control" type="date" id="issueDate" name="issueDate" required [(ngModel)]="newReport.issueDate" />
        <c-form-feedback [valid]="false">This field is required.</c-form-feedback>
      </c-col>
      <c-col md="6">
        <label cLabel for="reportStatus">Report Status</label>
        <select class="form-control" id="reportStatus" name="reportStatus" required [(ngModel)]="newReport.reportStatus">
          <option value="DRAFT">Draft</option>
          <option value="FINAL">Final</option>
        </select>
        <c-form-feedback [valid]="false">This field is required.</c-form-feedback>
      </c-col>

      <!-- Technology and Conditions -->
      <c-col md="12">
        <label cLabel for="technology">Technology</label>
        <input class="form-control" id="technology" name="technology" [(ngModel)]="newReport.technology" />
      </c-col>
      <c-col md="12">
        <label cLabel for="samplingConditionsDates">Sampling Conditions and Dates</label>
        <textarea class="form-control" id="samplingConditionsDates" name="samplingConditionsDates" [(ngModel)]="newReport.samplingConditionsDates"></textarea>
      </c-col>

      <!-- Action Buttons -->
      <c-col md="12" class="text-end mt-3">
        <button cButton color="primary" type="submit">{{ selectedReportId ? 'Save' : 'Add' }}</button>
        <button cButton color="secondary" (click)="closeModal()">Cancel</button>
      </c-col>
    </form>
  </c-modal-body>
</c-modal>

<!-- Lookup Modals -->
<app-project-lookup-modal [visible]="isProjectLookupOpen" (close)="isProjectLookupOpen = false"
                          (projectSelected)="onProjectSelected($event)"></app-project-lookup-modal>

<app-location-lookup-modal [visible]="isLocationLookupOpen" (close)="isLocationLookupOpen = false"
                           (locationSelected)="onLocationSelected($event)"></app-location-lookup-modal>

<app-sampling-record-lookup-modal [visible]="isSamplingRecordLookupOpen" (close)="isSamplingRecordLookupOpen = false"
                                  (selected)="onSamplingRecordSelected($event)"></app-sampling-record-lookup-modal>
