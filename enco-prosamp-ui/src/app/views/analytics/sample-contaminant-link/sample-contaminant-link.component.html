<div class="container mt-4">
  <h4>Vizsg√°land√≥ szennyez≈ëk kiv√°laszt√°sa a mint√°kb√≥l</h4>

  <!-- Sampling Record Selector (with Modal) -->
  <div class="form-group">
    <label class="form-label">Mintav√©teli jegyz≈ëk√∂nyv kiv√°laszt√°sa</label>
    <div class="d-flex align-items-center">
      <button class="btn btn-outline-primary me-3" (click)="openSamplingRecordModal()">üîç V√°lassz jegyz≈ëk√∂nyvet</button>
      <span *ngIf="selectedSamplingRecord">
      <strong>Azonos√≠t√≥:</strong> {{ selectedSamplingRecord.id }} |
      <strong>D√°tum:</strong> {{ selectedSamplingRecord.samplingDate | date:'yyyy-MM-dd' }} |
      <strong>Projekt:</strong> {{ selectedSamplingRecord.project.projectName }}
    </span>
    </div>
  </div>

  <!-- Lookup Modal -->
  <app-sampling-record-lookup-modal
    [visible]="showModal"
    (selected)="onSamplingRecordSelected($event)"
    (close)="showModal = false">
  </app-sampling-record-lookup-modal>

  <!-- Sample Cards -->
  <div *ngIf="samples.length > 0">
    <div *ngFor="let sample of samples" class="card my-4 border border-primary">
      <div class="card-header fw-bold bg-light">
        Minta jele: {{ sample.sampleIdentifier }} (Location: {{ sample.location }})
      </div>
      <div class="card-body">
        <!-- Group Buttons -->
        <label class="fw-semibold">Szennyez≈ëanyag csoportok:</label>
        <div class="mb-2">
          <button *ngFor="let group of contaminantGroups"
                  class="btn btn-outline-primary btn-sm mx-1"
                  (click)="assignGroup(sample.id, group.id)">
            + {{ group.name }}
          </button>
        </div>
        <div class="mb-2">
          <button *ngFor="let group of contaminantGroups"
                  class="btn btn-outline-danger btn-sm mx-1"
                  (click)="removeGroup(sample.id, group.id)">
            ‚àí {{ group.name }}
          </button>
        </div>

        <!-- Loading placeholder -->
        <div class="text-muted" *ngIf="!readySampleIds.has(sample.id)">
          <em>Loading contaminants...</em>
        </div>

        <!-- Contaminant Checkboxes -->
        <div class="row mt-3" *ngIf="readySampleIds.has(sample.id)">
          <div class="col-md-4" *ngFor="let contaminant of contaminants">
            <div class="form-check">
              <input class="form-check-input"
                     type="checkbox"
                     [checked]="selectedContaminants[sample.id].has(contaminant.id)"
                     (change)="toggleContaminant(sample.id, contaminant.id, $any($event.target).checked)">
              <label class="form-check-label">
                {{ contaminant.name }}
                <small class="text-muted">
                  ({{ contaminant.contaminantGroup.name || 'No Group' }})
                </small>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Save Button -->
    <button class="btn btn-success mt-3" (click)="saveAssignments()" [disabled]="isLoading">
      Szennyez≈ëk ment√©se
    </button>

    <!-- Error Message -->
    <div *ngIf="error" class="alert alert-danger mt-3">
      {{ error }}
    </div>
  </div>
</div>
